{% extends 'static/directory_index.html' %}
{% load i18n prev_dir %}
{% block styles %}
	{{ block.super }}
	<link rel="stylesheet" type="text/css" href="/static/css/editor.css" />	
{% endblock styles %}

{% block javascripts %}
	{{ block.super }}
	<script type="text/javascript" src="/static/codemirroreditor/js/codemirror.js"></script>
	<!--<script type="text/javascript" src="/static/codemirroreditor/js/mirrorframe.js"></script>-->
        <script type="text/javascript">
	  $(document).ready(function() {
          var source_value = $('#code').val();
  		  var editor = CodeMirror.fromTextArea("code", {
		    height: "600px",
		    content: source_value,
		    parserfile: ["tokenizejavascript.js", "parsejavascript.js"],
		    stylesheet: "/static/codemirroreditor/css/jscolors.css",
		    path: "/static/codemirroreditor/js/",
		    autoMatchParens: true
		  });
            var ConfirmDiscardchanges = function(){
                var new_value = editor.getCode();
                if ( new_value == source_value ) {
                    return true
                }
                if ( confirm('{% trans "Are you sure to close this file and discard all changes?" %}') == false ) {
                    return false;
                }
                return true;
            };
            $(document).unload(ConfirmDiscardchanges);
            $('a').click(function(e){
                e.stopPropagation();
                if ($(this).attr('id') != 'save' && $(this).attr('id') != 'discard' && $(this).attr('id') != 'close') {
                    return ConfirmDiscardchanges();
                }
            });
            $('#discard').click(function(){ if ( ConfirmDiscardchanges() ) document.location=document.location;});
            $('#close').click(function(){ if ( ConfirmDiscardchanges() ) document.location='{{ request.path|prev_dir }}';});
	  });
	</script>
{% endblock %}

{% block body %}
	<form action='/actions/test/save/' method='POST'>
		<input type="hidden" name="name" value="{{ relative_file_path }}" />
		<input type="hidden" name="url" value="{{ request.path }}" />
		{{ block.super }}
	</form>
{% endblock body %}

{% block controls %}
	<ul class="horizontal-menu">
		<li><a id="save" href="javascript:void(0);" onclick="$('form').submit();">Save</a></li>
		<li><a id="discard" href="javascript: void(0);">Discard</a></li>
		<li><a id="close" href="javascript: void(0);">Close</a></li>
	</ul>
{% endblock controls %}

{% block title %}<h4>{{ request.path|breadcrumbs_file }}</h4>{% endblock title %}

{% block content %}
	<textarea id='code'i name='content'>{{ content|default:"" }}</textarea>
{% endblock content %}
