{% extends 'static/directory_index.html' %}
{% load i18n dir_index_tags %}
{% block styles %}
	{{ block.super }}
	<link rel="stylesheet" type="text/css" href="/static/css/editor.css" />	
{% endblock styles %}

{% block javascripts %}
	{{ block.super }}
	<script type="text/javascript" src="/static/codemirroreditor/js/codemirror.js"></script>
	<!--<script type="text/javascript" src="/static/codemirroreditor/js/mirrorframe.js"></script>-->
        <script type="text/javascript">
        $.ctrl = function(key, callback, args) {
            $(document).keydown(function(e) {
                if(!args) args=[]; // IE barks when args is null
                if(e.keyCode == key.charCodeAt(0) && e.ctrlKey) {
                    callback.apply(this, args);
                    return false;
                }
            });
        };
   	  $(document).ready(function() {
          var source_value = $('#code').val();
  		  var editor = CodeMirror.fromTextArea("code", {
		    height: "600px",
		    content: source_value,
		    parserfile: ["tokenizejavascript.js", "parsejavascript.js"],
		    stylesheet: "/static/codemirroreditor/css/jscolors.css",
		    path: "/static/codemirroreditor/js/",
		    autoMatchParens: true
		  });
            var ConfirmDiscardchanges = function(){
                var new_value = editor.getCode();
                if ( new_value == source_value ) {
                    return true
                }
                if ( confirm('{% trans "Are you sure to close this file and discard all changes?" %}') == false ) {
                    return false;
                }
                return true;
            };
            $(document).unload(ConfirmDiscardchanges);
            $('a').click(function(e){
                e.stopPropagation();
                if ($(this).attr('id') != 'save' && $(this).attr('id') != 'run' && $(this).attr('id') != 'discard' && $(this).attr('id') != 'close') {
                    return ConfirmDiscardchanges();
                }
            });
            $('#discard').click(function(){ if ( ConfirmDiscardchanges() ) document.location=document.location;});
            $('#close').click(function(){ if ( ConfirmDiscardchanges() ) document.location='{{ request.path|above }}';});
            $('#run').click(function(){ $('#apply-test').attr('action', '/actions/test/submit/').attr('target', '_blank');$('#apply-test').submit(); });
            $('#save').click(function(){ $('#apply-test').attr('action', '/actions/test/save/');$('#apply-test').submit(); });
            $.ctrl('S', function(){ $('#save').trigger('click'); });
	  });
	</script>
{% endblock %}

{% block controls %}
	<ul class="horizontal-menu">
		<li><a id="run" href="javascript:void(0);">{% trans "Run" %}</a></li>
		<li><a id="save" href="javascript:void(0);">{% trans "Save" %}</a></li>
		<li><a id="discard" href="javascript: void(0);">{% trans "Discard" %}</a></li>
		<li class="disabled"><a id="history" href="javascript: void(0);">{% trans "History" %}</a></li>
		<li><a id="close" href="javascript: void(0);">{% trans "Close" %}</a></li>
	</ul>
{% endblock controls %}

{% block title %}<h4>{{ request.path|breadcrumbs_file }}</h4>{% endblock title %}

{% block content %}
	<form id='apply-test' method='POST'>
		<input type="hidden" name="path" value="{{ relative_file_path }}" />
		<input type="hidden" name="url" value="{{ request.path }}" />
		<textarea id='code' name='content'>{{ content|default:"" }}</textarea>
	</form>
{% endblock content %}
